# Auditoria de Código e Otimização

## SessionCockpitScreen.kt
- **Pager e tabs recompondo mais que o necessário:** `rememberPagerState` e `rememberCoroutineScope` estão dentro da própria tela e as ações de clique iniciam corrotinas ad-hoc, o que força leituras diretas de `currentPage` em cada recomposição; mover as ações para callbacks memorizados com `remember`/`derivedStateOf` e usar `key` estável no `HorizontalPager` evita trabalho extra e facilita testes.【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L47-L139】
- **Gestos do mapa alocam objetos por frame:** o `ImageRequest.Builder` e os estados `scale/offset/rotation` são recriados na recomposição; extrair o builder para `remember(scene?.mapImageUri)` e usar `rememberTransformableState` concentraria mutações em um único estado estável, reduzindo churn de alocação durante pinch/rotate/drag.【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L260-L318】
- **Listagem de combatentes sem chave estável:** `LazyColumn` itera `combat.participants` sem `key = { it.id }`, impedindo reuso de itens e reiniciando animações quando a ordem muda; adicionar chave e isolar as barras de HP/MP em composables stateless evita recomposição total a cada atualização de progresso.【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L371-L520】
- **SwipeToDismiss com efeito colateral na confirmação:** `rememberDismissState` aplica condição dentro de `confirmValueChange`, podendo disparar múltiplas vezes se o estado oscilar; mover o efeito para um `LaunchedEffect(dismissState.currentValue)` e resetar o estado após tratar evita loops e deixa o gesto responsivo.【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L388-L520】
- **Acesso inseguro ao turno atual:** `combat.participants[combat.currentTurnIndex]` assume lista não vazia; proteger com `getOrNull` e fallback evita `IndexOutOfBoundsException` quando o combate inicia vazio ou o índice sai do intervalo.【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L371-L383】

## GMDashboardScreen.kt
- **LaunchedEffect infinito:** o loop `while (true)` atualiza o contador a cada segundo sem cancelamento vinculado ao timestamp; usar `produceState` ou `LaunchedEffect(timestamp)` com `awaitFrame`/`delay` cancelável evita consumo contínuo quando o composable sai da árvore.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMDashboardScreen.kt†L77-L172】
- **Grid sem chave e densidade fixa:** `LazyVerticalGrid` usa `GridCells.Fixed(4)` e não fornece `key`; parametrizar o número de colunas (ex.: via `WindowSizeClass`) e adicionar `key = { it.id }` melhora reuso e acessibilidade em telas menores.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMDashboardScreen.kt†L37-L75】
- **Alocações em cards:** o gradiente e o `ImageRequest.Builder` são recriados a cada recomposição do `CampaignCard`; memorizar o `Brush` e o request com `remember(campaign.coverUri)` reduz GC e suaviza scroll do grid.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMDashboardScreen.kt†L93-L173】

## GMForgeMappers.kt
- **IDs sintéticos frágeis:** `toCampaignCards` gera `id` por índice e preenche campos com sentinelas (`coverUri = ""`, `playerCount = 4`), o que causa colisões em reordenação ou paginação; preferir IDs reais do modelo ou `UUID.randomUUID()` e permitir nulos para dados desconhecidos.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMForgeMappers.kt†L19-L35】
- **Valores aleatórios não determinísticos:** iniciativas e posições usam `random()` sem fonte previsível; injetar um `Random` ou `seed` (parâmetro opcional) facilita testes e reproduções de UI previews.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMForgeMappers.kt†L37-L86】
- **Mapeamentos sem sinalização de erro:** `getActiveScene` e `toTimelineScenes` retornam vazios silenciosamente quando índices estão fora do alcance; retornar `Result` ou logar avisos ajuda a detectar estado inconsistente e melhora a UX de fallback.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMForgeMappers.kt†L101-L146】

## MestreViewModel.kt
- **Combine com casts inseguros e listas mutáveis:** o `combine` de nove flows usa `as` para converter `Any`, expondo o código a `ClassCastException` se o repositório mudar; preferir destructuring no lambda e data classes imutáveis para transmitir o snapshot do repositório de forma typesafe.【F:app/src/main/java/com/mestre3dt/ui/MestreViewModel.kt†L87-L132】
- **Persistência redundante e trabalho em Main:** `persistLocalSnapshot()` é chamado após várias mutações sequenciais (ex.: `addArc`, `addScene`, `endSessionWithSummary`), potencialmente rodando I/O no thread padrão; centralizar a persistência com `debounce` em `viewModelScope` (Dispatcher.IO) reduz bloqueios e duplicação.【F:app/src/main/java/com/mestre3dt/ui/MestreViewModel.kt†L130-L230】
- **Estado derivado refeito a cada tick:** o cálculo de `encounter = if (ui.encounter.isEmpty()) ... else ui.encounter` roda a cada emissão das 9 flows mesmo quando nada relacionado muda; extrair para um `distinctUntilChanged` ou mover o cálculo para o repositório evita recomposições desnecessárias nas telas que consomem `uiState`.【F:app/src/main/java/com/mestre3dt/ui/MestreViewModel.kt†L107-L132】

## Componentes Compartilhados
- **Dialogs sem tema/tokens reutilizáveis:** `DeleteConfirmationDialog` está hardcoded para textos e cores padrão; aceitar `text`/`onConfirmText` e `shape`/`colors` permite reutilização e consistência com o design system, além de facilitar testes de acessibilidade.【F:app/src/main/java/com/mestre3dt/ui/components/CommonComponents.kt†L3-L25】
