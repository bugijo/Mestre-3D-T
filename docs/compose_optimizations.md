# Compose Optimization Recommendations

## SessionCockpitScreen.kt
- **Stabilize pager and tab interactions**: Lift `rememberPagerState` and coroutine scope out of recomposition by keeping them at the screen level only; ensure any derived values use `remember` to avoid extra recompositions when `combat` or `scene` changes. Consider `rememberCoroutineScope()` reuse or `LaunchedEffect(pagerState.currentPage)` for reactions instead of inline `launch` calls inside `onClick`.【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L47-L139】
- **Avoid rebuilding large images**: Wrap the map image `ImageRequest` in `remember(scene?.mapImageUri)` and use `rememberTransformableState` from `foundation` to consolidate gesture handling; this reduces allocations inside the gesture lambda and keeps `scale/offset/rotation` updates stable. Debounce the reset FAB by hoisting transform state to a small data class with `remember` to prevent unnecessary recompositions of the entire `MapTab`.【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L210-L275】
- **Minimize `LazyColumn` work**: In `CombatTab`, pass `key = { it.id }` to `items` and move `animateFloatAsState` calls behind `remember(participant.id)` to avoid restarting animations when unrelated state changes occur. Extract the HP/MP bars into stateless composables to isolate recompositions triggered by progress updates.【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L302-L414】
- **Compose best practices**: Prefer state hoisting for `showQuickActions` to allow parent coordination, and gate expensive `AnimatedVisibility` with `rememberSaveable` to restore toggles after configuration changes. Replace broad wildcard imports with explicit ones to clarify API sources and reduce accidental API mixing (e.g., `foundation.pager` vs. accompanist).【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L327-L414】
- **Dismiss handling**: `rememberDismissState` currently performs side effects in `confirmValueChange`; move condition application to `LaunchedEffect` keyed on dismiss value and return `true/false` explicitly to avoid recomposition loops. Alternatively, use `DismissState`'s `reset()` from a coroutine to keep UI responsive.【F:app/src/main/java/com/mestre3dt/ui/screens/SessionCockpitScreen.kt†L333-L360】

## GMDashboardScreen.kt
- **Stabilize countdown**: The `LaunchedEffect` with an infinite loop will recompose every second; scope the effect to `timestamp` and compute `timeRemaining` with `produceState` to keep the composable stateless. Memoize static strings (`sessionTitle`, `sessionDate`) if derived from state, and extract the countdown row into a separate composable that only depends on the remaining time.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMDashboardScreen.kt†L35-L121】
- **Lazy grid performance**: Provide `key = { it.id }` in `items` to improve item reuse, and move layout constants (`GridCells.Fixed(4)`, spacings) to a `@Stable` configuration object or `remember` to avoid unnecessary recompositions of `LazyVerticalGrid`. Consider making `CampaignCardData` `@Immutable` to aid Compose optimizations.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMDashboardScreen.kt†L41-L71】
- **Card content recomposition**: In `CampaignCard`, blur and gradient overlays are recreated on every recomposition. Extract the gradient brush into `remember` and lift the `ImageRequest` builder to avoid repeated allocations. Move the bottom-aligned column into a dedicated composable that receives only the fields it displays to reduce the surface area of recompositions when other properties change.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMDashboardScreen.kt†L89-L205】

## GMForgeMappers.kt
- **Mapping efficiency**: Current mapping rebuilds lists on every call. Cache derived totals (e.g., `campaign.arcs.flatMap`) with local `val` and consider returning `persistentListOf` if immutability is important. When randomness is used (`(0..10).random()`), seed via `Random` passed as a parameter for deterministic previews and tests.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMForgeMappers.kt†L17-L83】
- **Null-safety and defaults**: Replace placeholder values (`coverUri = ""`, `playerCount = 4`) with nullable fields or sealed result types that encode "unknown" rather than sentinel values. Map enemy data defensively by checking for missing IDs or HP and providing fallbacks to avoid crashes when backend contracts change.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMForgeMappers.kt†L21-L83】
- **Composable-friendly models**: Mark DTOs like `CampaignCardData`, `SessionParticipant`, and `TimelineScene` as `@Immutable` (from `compose.runtime`) to help Compose skip recompositions. When using `TimeRemaining`, offer a `Flow<TimeRemaining>` or `StateFlow` producer to share computation across screens instead of recomputing per composable.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMForgeMappers.kt†L85-L137】
- **Error handling**: Wrap mapping functions with result types (e.g., `Result<List<...>>`) or provide logging when expected campaign/arc indices are missing (`getOrNull` returning null) to aid debugging while keeping UI stable. Consider Kotlinx Serialization annotations if these models are persisted or exchanged over the network; ensuring default values via `@Serializable` helps avoid missing-field exceptions.【F:app/src/main/java/com/mestre3dt/ui/screens/gmforge/GMForgeMappers.kt†L87-L137】
